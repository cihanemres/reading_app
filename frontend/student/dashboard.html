<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–ÄŸrenci Paneli - Okuma GeliÅŸtirme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="../css/animations.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <link rel="stylesheet" href="../css/notifications.css">
    <link rel="stylesheet" href="../css/gamification.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .subject-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .subject-card.active {
            ring: 2px solid;
            transform: scale(1.05);
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Navbar (Same as before) -->
    <nav class="bg-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-book-reader text-2xl text-purple-600 mr-3"></i>
                    <span class="text-xl font-bold text-gray-800">Ã–ÄŸrenci Paneli</span>
                </div>
                <!-- Navbar Items -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-semibold text-gray-800" id="userName">...</p>
                        <p class="text-xs text-gray-500" id="userGrade"></p>
                    </div>
                    <div id="notificationBell"></div>
                    <button id="themeToggle" class="p-2 rounded-lg hover:bg-gray-100 transition"><i
                            class="fas fa-moon text-gray-600"></i></button>
                    <button onclick="window.location.href='../profile.html'"
                        class="hidden md:block text-purple-600 hover:text-purple-700"><i
                            class="fas fa-user-cog text-xl"></i></button>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700"><i
                            class="fas fa-sign-out-alt text-xl"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Welcome Section -->
        <div class="gradient-bg text-white rounded-xl p-6 md:p-8 mb-8 shadow-lg">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-2">HoÅŸ Geldin, <span id="welcomeName">Ã–ÄŸrenci</span>!
                        ðŸ‘‹</h1>
                    <p class="text-purple-100">BugÃ¼n hangi dersten hikÃ¢ye okumak istersin?</p>
                </div>
                <div class="flex space-x-4 mt-4 md:mt-0">
                    <!-- XP -->
                    <div class="bg-white/20 backdrop-blur rounded-lg px-4 py-2 text-center">
                        <p class="text-xs text-purple-200">XP PuanÄ±</p>
                        <p class="text-xl font-bold" id="userXP">0</p>
                    </div>
                    <!-- Level -->
                    <div class="bg-white/20 backdrop-blur rounded-lg px-4 py-2 text-center">
                        <p class="text-xs text-purple-200">Seviye</p>
                        <p class="text-xl font-bold" id="userLevel">1</p>
                    </div>
                    <!-- Streak -->
                    <div class="bg-white/20 backdrop-blur rounded-lg px-4 py-2 text-center">
                        <p class="text-xs text-purple-200">Seri ðŸ”¥</p>
                        <p class="text-xl font-bold" id="userStreak">0</p>
                    </div>
                    <!-- Messages -->
                    <a href="../messages.html"
                        class="bg-white/20 backdrop-blur rounded-lg px-4 py-2 text-center hover:bg-white/30 transition relative">
                        <p class="text-xs text-purple-200">Mesajlar</p>
                        <p class="text-xl font-bold"><i class="fas fa-envelope"></i></p>
                        <span id="unreadMessageBadge"
                            class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold"></span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Subject Selection -->
        <div class="mb-8 overflow-x-auto pb-4">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i
                    class="fas fa-th-large mr-2 text-purple-600"></i>Dersler</h2>
            <div class="flex space-x-4 md:grid md:grid-cols-4 lg:grid-cols-7 min-w-max md:min-w-0">
                <div onclick="filterBySubject(null)"
                    class="subject-card active bg-gray-100 p-4 rounded-xl cursor-pointer text-center w-32 md:w-auto flex-shrink-0"
                    id="subject-all">
                    <div
                        class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-2 text-gray-600">
                        <i class="fas fa-layer-group text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">TÃ¼mÃ¼</span>
                </div>
                <div onclick="filterBySubject('TÃ¼rkÃ§e')"
                    class="subject-card bg-red-50 p-4 rounded-xl cursor-pointer text-center w-32 md:w-auto flex-shrink-0"
                    id="subject-TÃ¼rkÃ§e">
                    <div
                        class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-2 text-red-500">
                        <i class="fas fa-book text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">TÃ¼rkÃ§e</span>
                </div>
                <div onclick="filterBySubject('Matematik')"
                    class="subject-card bg-blue-50 p-4 rounded-xl cursor-pointer text-center w-32 md:w-auto flex-shrink-0"
                    id="subject-Matematik">
                    <div
                        class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2 text-blue-500">
                        <i class="fas fa-calculator text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">Matematik</span>
                </div>
                <div onclick="filterBySubject('Fen Bilimleri')"
                    class="subject-card bg-green-50 p-4 rounded-xl cursor-pointer text-center w-32 md:w-auto flex-shrink-0"
                    id="subject-Fen Bilimleri">
                    <div
                        class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2 text-green-500">
                        <i class="fas fa-flask text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">Fen Bil.</span>
                </div>
                <div onclick="filterBySubject('Sosyal Bilgiler')"
                    class="subject-card bg-yellow-50 p-4 rounded-xl cursor-pointer text-center w-32 md:w-auto flex-shrink-0"
                    id="subject-Sosyal Bilgiler">
                    <div
                        class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-2 text-yellow-500">
                        <i class="fas fa-globe-americas text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">Sosyal Bil.</span>
                </div>
                <div onclick="filterBySubject('Ä°ngilizce')"
                    class="subject-card bg-indigo-50 p-4 rounded-xl cursor-pointer text-center w-32 md:w-auto flex-shrink-0"
                    id="subject-Ä°ngilizce">
                    <div
                        class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2 text-indigo-500">
                        <i class="fas fa-language text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">Ä°ngilizce</span>
                </div>
                <div onclick="filterBySubject('Din KÃ¼ltÃ¼rÃ¼')"
                    class="subject-card bg-emerald-50 p-4 rounded-xl cursor-pointer text-center w-32 md:w-auto flex-shrink-0"
                    id="subject-Din KÃ¼ltÃ¼rÃ¼">
                    <div
                        class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-2 text-emerald-500">
                        <i class="fas fa-star-and-crescent text-xl"></i>
                    </div>
                    <span class="font-bold text-gray-700 text-sm">Din KÃ¼l.</span>
                </div>
            </div>
        </div>

        <!-- Search & Content -->
        <div class="bg-white rounded-xl shadow-md p-6 min-h-[500px]">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-bold text-gray-800" id="contentTitle">TÃ¼m HikÃ¢yeler</h2>
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <!-- Grade Filter -->
                    <select id="gradeFilter" onchange="filterByGrade(this.value)"
                        class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-purple-500">
                        <option value="">TÃ¼m SÄ±nÄ±flar</option>
                        <option value="1">1. SÄ±nÄ±f</option>
                        <option value="2">2. SÄ±nÄ±f</option>
                        <option value="3">3. SÄ±nÄ±f</option>
                        <option value="4">4. SÄ±nÄ±f</option>
                        <option value="5">5. SÄ±nÄ±f</option>
                        <option value="6">6. SÄ±nÄ±f</option>
                        <option value="7">7. SÄ±nÄ±f</option>
                        <option value="8">8. SÄ±nÄ±f</option>
                    </select>
                    <!-- Search -->
                    <div class="relative flex-1 md:w-64">
                        <input type="text" id="storySearch" placeholder="HikÃ¢ye ara..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- Stories Grid -->
            <div id="storiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Loaded via JS -->
            </div>
            <div id="noStories" class="hidden text-center py-12">
                <i class="fas fa-search text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500">AradÄ±ÄŸÄ±nÄ±z kriterlere uygun hikÃ¢ye bulunamadÄ±.</p>
            </div>
        </div>

        <!-- Stats Section (Optional - kept simple) -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Okunan HikÃ¢ye</p>
                        <p class="text-2xl font-bold text-purple-600" id="totalStories">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
                        <i class="fas fa-book-reader"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Rozetler</p>
                        <p class="text-2xl font-bold text-orange-600" id="totalBadges">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                        <i class="fas fa-medal"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Pratik</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalPractice">0</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i
                            </div>
                    </div>
                    <a href="my-progress.html"
                        class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer block">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">Ä°lerleme Grafiklerim</p>
                                <p class="text-lg font-bold text-green-600">GÃ¶rÃ¼ntÃ¼le â†’</p>
                            </div>
                            <div
                                class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Assignments Section -->
            <div class="container mx-auto px-6 mb-8 hidden" id="assignmentsSection">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2 flex items-center gap-2">
                    <i class="fas fa-tasks text-yellow-500"></i>
                    Ã–devlerim
                </h2>
                <div id="assignmentsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Assignment cards -->
                </div>
            </div>

            <!-- All Badges Modal (kept for compatibility if needed) -->
            <!-- ... -->

            <script src="../js/api.js"></script>
            <script src="../js/auth.js"></script>
            <script src="../js/search.js"></script>
            <script src="../js/gamification.js"></script>
            <script src="../js/theme.js"></script>
            <script src="../js/notifications.js"></script>

            <script>
                if (!checkAuth()) window.location.href = '../login.html';
                const user = getCurrentUserInfo();

                document.getElementById('userName').textContent = user.ad_soyad;
                document.getElementById('welcomeName').textContent = user.ad_soyad.split(' ')[0]; // First name
                document.getElementById('userGrade').textContent = user.sinif_duzeyi ? `${user.sinif_duzeyi}. SÄ±nÄ±f` : '';

                // Load gamification stats
                async function loadGamificationStats() {
                    try {
                        const stats = await API.getMyGamificationStats();
                        if (stats) {
                            document.getElementById('userXP').textContent = stats.total_xp || 0;
                            document.getElementById('userLevel').textContent = stats.level || 1;
                            document.getElementById('userStreak').textContent = stats.streak_days || 0;
                        }
                    } catch (error) {
                        console.error('Error loading gamification stats:', error);
                    }
                }
                loadGamificationStats();

                // Load unread message count
                async function loadUnreadMessages() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/messages/inbox`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const unreadCount = data.unread || 0;
                            const badge = document.getElementById('unreadMessageBadge');
                            if (unreadCount > 0) {
                                badge.textContent = unreadCount;
                                badge.classList.remove('hidden');
                            }
                        }
                    } catch (e) {
                        console.log('Could not load unread messages:', e);
                    }
                }
                loadUnreadMessages();

                let currentSubject = null;
                let currentSearch = '';
                let currentGrade = null;

                function filterByGrade(grade) {
                    currentGrade = grade || null;
                    loadStories();
                }

                function logout() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '../login.html';
                }

                async function loadAssignments() {
                    const section = document.getElementById('assignmentsSection');
                    const container = document.getElementById('assignmentsContainer');

                    try {
                        const assignments = await API.getMyAssignments();
                        if (!assignments || assignments.length === 0) {
                            section.classList.add('hidden');
                            return;
                        }

                        section.classList.remove('hidden');
                        container.innerHTML = assignments.map(a => {
                            const dueDate = a.due_date ? new Date(a.due_date).toLocaleDateString('tr-TR') : 'Tarih Yok';
                            return `
                    <div class="bg-white rounded-xl shadow-sm border-l-4 border-yellow-400 p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-semibold">Ã–dev</span>
                            <span class="text-xs text-red-500 font-medium"><i class="far fa-clock mr-1"></i>${dueDate}</span>
                        </div>
                        <h3 class="font-bold text-gray-800 mb-1 truncate">${a.story_title}</h3>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-1">${a.subject}</p>
                        <a href="story-view.html?id=${a.story_id}" class="block text-center w-full bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 transition font-medium shadow-sm">
                            <i class="fas fa-play mr-1"></i> BaÅŸla
                        </a>
                    </div>
                `}).join('');
                    } catch (e) {
                        console.error("Assignment load error", e);
                    }
                }

                async function loadStories() {
                    loadAssignments();
                    const container = document.getElementById('storiesContainer');
                    const noStories = document.getElementById('noStories');

                    container.innerHTML = '<div class="col-span-full text-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-purple-600"></i></div>';
                    noStories.classList.add('hidden');

                    try {
                        // Fetch stories with grade filter (null = all grades)
                        const gradeToUse = currentGrade || null;
                        const stories = await API.getStories(gradeToUse, currentSearch, currentSubject);

                        container.innerHTML = '';

                        if (stories.length === 0) {
                            noStories.classList.remove('hidden');
                            return;
                        }

                        const baseUrl = API_BASE_URL.replace('/api', '');

                        container.innerHTML = stories.map(story => {
                            const imageUrl = story.kapak_gorseli
                                ? `${baseUrl}/${story.kapak_gorseli}`
                                : `https://placehold.co/600x400/eee/999?text=${encodeURIComponent(story.ders || 'Hikaye')}`;

                            return `
                    <div class="group bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 cursor-pointer flex flex-col h-full"
                        onclick="window.location.href='story-view.html?id=${story.id}'">
                        <div class="relative overflow-hidden h-40">
                            <img src="${imageUrl}" alt="${story.baslik}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute top-2 right-2 bg-white bg-opacity-90 px-2 py-1 rounded-md text-xs font-bold text-gray-700 shadow-sm">
                                ${story.ders || 'Genel'}
                            </div>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <h3 class="font-bold text-gray-800 mb-1 line-clamp-2 leading-tight group-hover:text-purple-600 transition">${story.baslik}</h3>
                            <p class="text-xs text-gray-500 mb-3 line-clamp-2 flex-1">${story.konu_ozeti || story.metin.substring(0, 80) + '...'}</p>
                            
                            <div class="flex items-center justify-between text-xs text-gray-400 mt-auto border-t pt-3">
                                <span><i class="fas fa-file-alt mr-1"></i>${story.kelime_sayisi || 0} kelime</span>
                                <span class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full font-semibold">Oku</span>
                            </div>
                        </div>
                    </div>
                    `;
                        }).join('');

                    } catch (error) {
                        console.error(error);
                        container.innerHTML = '<div class="col-span-full text-center text-red-500">YÃ¼klenirken hata oluÅŸtu.</div>';
                    }
                }

                async function loadStats() {
                    try {
                        const progress = await API.getMyProgress();
                        document.getElementById('totalStories').textContent = progress.okunan_hikaye_sayisi || 0;
                        document.getElementById('totalPractice').textContent = progress.toplam_pratik || 0;
                        // Badges can be loaded from gamification.js logic if needed
                        const data = await API.getMyBadges();
                        document.getElementById('totalBadges').textContent = data.badges ? data.badges.length : 0;
                    } catch (e) {
                        console.warn("Stats error", e);
                    }
                }

                function filterBySubject(subject) {
                    currentSubject = subject;

                    // UI Update
                    document.querySelectorAll('.subject-card').forEach(el => {
                        el.classList.remove('active', 'ring-2', 'ring-purple-500');
                        if ((subject === null && el.id === 'subject-all') || el.id === `subject-${subject}`) {
                            el.classList.add('active', 'ring-2', 'ring-purple-500');
                        }
                    });

                    document.getElementById('contentTitle').textContent = subject ? `${subject} HikÃ¢yeleri` : 'TÃ¼m HikÃ¢yeler';
                    loadStories();
                }

                // Search Setup
                SearchUtils.setupSearch('storySearch', (val) => {
                    currentSearch = val;
                    loadStories();
                });

                // Initialize
                loadStories();
                loadStats();
            </script>

            <!-- Mobile Bottom Navigation -->
            <nav class="mobile-bottom-nav">
                <a href="dashboard.html" class="mobile-nav-item active">
                    <i class="fas fa-home"></i>
                    <span>Ana Sayfa</span>
                </a>
                <a href="../messages.html" class="mobile-nav-item">
                    <i class="fas fa-envelope"></i>
                    <span>Mesajlar</span>
                </a>
                <a href="my-progress.html" class="mobile-nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Ä°lerleme</span>
                </a>
                <a href="../profile.html" class="mobile-nav-item">
                    <i class="fas fa-user"></i>
                    <span>Profil</span>
                </a>
            </nav>

            <script>
                function showGamificationModal() {
                    alert('Rozetler ve XP durumun iÃ§in Ä°lerleme sayfasÄ±na git!');
                }
            </script>
</body>

</html>